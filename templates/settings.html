{% extends 'base.html' %}
{% block content %}
<h2>Paramètres de connexion</h2>
<form method="post" class="card grid">
    <div>
        <h3>IMAP</h3>
        <label for="imap_host">Serveur IMAP</label>
        <input type="text" id="imap_host" name="imap_host" value="{{ config.imap_host or '' }}" required>

        <label for="imap_port">Port IMAP</label>
        <input type="number" id="imap_port" name="imap_port" value="{{ config.imap_port or 993 }}">

        <label>
            <input type="checkbox" name="use_ssl" {% if config.use_ssl %}checked{% endif %}> Utiliser SSL
        </label>

        <label for="imap_username">Utilisateur IMAP</label>
        <input type="text" id="imap_username" name="imap_username" value="{{ config.imap_username or '' }}" required>

        <label for="imap_password">Mot de passe IMAP</label>
        <input type="password" id="imap_password" name="imap_password" value="{{ config.imap_password or '' }}" required>
    </div>
    <div>
        <h3>SMTP (optionnel)</h3>
        <label for="smtp_host">Serveur SMTP</label>
        <input type="text" id="smtp_host" name="smtp_host" value="{{ config.smtp_host or '' }}">

        <label for="smtp_port">Port SMTP</label>
        <input type="number" id="smtp_port" name="smtp_port" value="{{ config.smtp_port or '' }}">

        <label for="smtp_username">Utilisateur SMTP</label>
        <input type="text" id="smtp_username" name="smtp_username" value="{{ config.smtp_username or '' }}">

        <label for="smtp_password">Mot de passe SMTP</label>
        <input type="password" id="smtp_password" name="smtp_password" value="{{ config.smtp_password or '' }}">
    </div>
    <div class="form-actions full-width">
        <button type="submit" class="button">Enregistrer</button>
        <a class="button secondary" href="{{ url_for('main.index') }}">Retour</a>
    </div>
</form>

<h3>Tests de connexion</h3>
<div class="grid">
    <form method="post" action="{{ url_for('main.test_imap_connection') }}" class="card async-test-form" data-status-target="imap-status">
        <p>Vérifie la connexion au serveur IMAP configuré.</p>
        <div class="test-status" id="imap-status" aria-live="polite"></div>
        <button type="submit" class="button">Tester IMAP</button>
    </form>
    <form method="post" action="{{ url_for('main.test_smtp_connection') }}" class="card async-test-form" data-status-target="smtp-status">
        <p>Vérifie la connexion au serveur SMTP configuré.</p>
        <div class="test-status" id="smtp-status" aria-live="polite"></div>
        <button type="submit" class="button">Tester SMTP</button>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const forms = document.querySelectorAll('.async-test-form');

        const setStatus = (container, message, status) => {
            if (!container) return;
            container.classList.remove('success', 'error', 'loading');
            if (status) container.classList.add(status);
            container.innerHTML = message;
        };

        forms.forEach((form) => {
            const statusTarget = form.dataset.statusTarget;
            const statusContainer = document.getElementById(statusTarget);
            const submitButton = form.querySelector('button[type="submit"]');

            form.addEventListener('submit', (event) => {
                event.preventDefault();
                if (statusContainer) {
                    setStatus(
                        statusContainer,
                        '<span class="spinner"></span> Test en cours…',
                        'loading',
                    );
                }
                if (submitButton) {
                    submitButton.disabled = true;
                }

                const controller = new AbortController();
                const abortTimeout = setTimeout(() => controller.abort(), 15000);

                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    signal: controller.signal,
                })
                    .then(async (response) => {
                        clearTimeout(abortTimeout);
                        let payload;
                        try {
                            payload = await response.json();
                        } catch (error) {
                            throw new Error('Réponse inattendue du serveur.');
                        }

                        const status = payload.success ? 'success' : 'error';
                        setStatus(statusContainer, payload.message, status);
                    })
                    .catch((error) => {
                        const message = error.name === 'AbortError'
                            ? 'Test annulé : délai dépassé.'
                            : error.message || 'Le test a échoué.';
                        setStatus(statusContainer, message, 'error');
                    })
                    .finally(() => {
                        if (submitButton) {
                            submitButton.disabled = false;
                        }
                    });
            });
        });
    });
</script>
{% endblock %}
